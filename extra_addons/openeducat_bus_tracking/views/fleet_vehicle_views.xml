<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Form View for Fleet Vehicle with GPS Tracking -->
    <record id="view_fleet_vehicle_form_inherit_gps_tracking" model="ir.ui.view">
        <field name="name">fleet.vehicle.form.inherit.gps.tracking</field>
        <field name="model">fleet.vehicle</field>
        <field name="inherit_id" ref="fleet.fleet_vehicle_view_form"/>
        <field name="arch" type="xml">
            <!-- Target the main form view directly after the main content -->
            <xpath expr="//form/sheet/notebook" position="inside">
                <page string="GPS Tracking" name="gps_tracking">
                    <group>
                        <group string="Current Position">
                            <field name="last_updated" widget="datetime" options="{'datepicker': {'minDate': false, 'maxDate': false, 'date': false, 'time': false, 'datetime': false}, 'datepickerInputs': false}" class="oe_inline" readonly="1"/>
                            <field name="last_location" readonly="1"/>
                            <div class="o_row">
                                <field name="latitude" class="oe_inline" readonly="1"/>
                                <field name="longitude" class="oe_inline" readonly="1"/>
                                <field name="speed" class="oe_inline" readonly="1">
                                    <span>km/h</span>
                                </field>
                            </div>
                        </group>
                        <group string="GPS Logs">
                            <field name="gps_log_count" widget="statinfo" string="Log Entries" nolabel="1"/>
                            <div class="oe_edit_only" style="padding-left: 90px;">
                                <button name="action_view_gps_logs" type="object"
                                        class="oe_stat_button" icon="fa-map-marker"
                                        invisible="gps_log_count == 0">
                                    <field string="View Logs" name="gps_log_count" widget="statinfo"/>
                                </button>
                            </div>
                        </group>
                    </group>
                </page>
            </xpath>
        </field>
    </record>

    <!-- Kanban View for Vehicle List -->
    <record id="view_fleet_vehicle_kanban_inherit_gps_tracking" model="ir.ui.view">
        <field name="name">fleet.vehicle.kanban.inherit.gps.tracking</field>
        <field name="model">fleet.vehicle</field>
        <field name="inherit_id" ref="fleet.fleet_vehicle_view_kanban"/>
        <field name="arch" type="xml">
            <xpath expr="//templates" position="inside">
                <t t-name="fleet_vehicle_kanban.GPSTracking">
                    <div class="oe_kanban_gps_tracking">
                        <div t-if="record.last_updated.raw_value" class="o_kanban_gps_info">
                            <i class="fa fa-map-marker"/> 
                            <span t-esc="record.last_location.raw_value or 'No location data'" class="ml-2"/>
                        </div>
                        <div class="o_kanban_gps_metrics">
                            <div t-if="record.speed.raw_value" class="o_kanban_gps_metric">
                                <i class="fa fa-tachometer"/> 
                                <span t-esc="Math.round(record.speed.raw_value) + ' km/h'"/>
                            </div>
                            <div t-if="record.last_updated.raw_value" class="o_kanban_gps_metric">
                                <i class="fa fa-clock-o"/> 
                                <span t-esc="record.last_updated.raw_value"/>
                            </div>
                        </div>
                    </div>
                </t>
            </xpath>
            <xpath expr="//kanban" position="attributes">
                <attribute name="class">o_kanban_dashboard o_kanban_ungrouped</attribute>
            </xpath>
            <xpath expr="//kanban//templates//field[@name='model_id']/.." position="after">
                <t t-call="fleet_vehicle_kanban.GPSTracking"/>
            </xpath>
        </field>
    </record>

    <!-- Action for Vehicle List -->
    <record id="action_fleet_vehicle_gps_list" model="ir.actions.act_window">
        <field name="name">Bus Tracking</field>
        <field name="res_model">fleet.vehicle</field>
        <field name="view_mode">kanban,form</field>
        <field name="context">{"search_default_filter_available": 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No vehicles found. Let's create one!
            </p>
        </field>
    </record>
</odoo>
